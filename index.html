<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - User Trend Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            display: flex;
            flex-direction: column;
            margin: 0;
            height: 100vh;
        }

        #content-container {
            display: flex;
            flex: 1;
            flex-direction: row;
            overflow: hidden;
        }

        #chart-container {
            flex: 2;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #text-container {
            flex: 1;
            padding: 20px;
            box-sizing: border-box;
            border-left: 1px solid #ccc;
            overflow-y: auto;
        }

        canvas {
            width: 100%;
            height: 90%;
        }
    </style>
</head>
<body>
    <h1>Trend Analysis Dashboard</h1>

    <div>
        <label for="demographic-toggle">Patient Demographic:</label>
        <select id="demographic-toggle" onchange="applyFilters()" onload="applyFilters()">
            <option value="none" selected>Overall</option>
            <option value="Gender">Gender</option>
            <option value="Province">Province</option>
            <option value="HealthCondition">Health Condition</option>
            <option value="AgeGroup">Age Group</option>
        </select>
    </div>

    <label>
        <input type="checkbox" id="show-filters" onchange="toggleFilters()"> Show Filters
    </label>

    <div id="filters-container" style="display: none;">
        <div>
            <label for="filter-gender">Gender:</label>
            <select id="filter-gender">
                <option value="">All</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
            </select>

            <label for="filter-province">Province:</label>
            <select id="filter-province">
                <option value="">All</option>
            </select>

            <label for="filter-health">Health Condition:</label>
            <select id="filter-health">
                <option value="">All</option>
            </select>

            <label for="filter-age-group">Age Group:</label>
            <select id="filter-age-group">
                <option value="">All</option>
            </select>

            <label for="grouping">Group By:</label>
            <select id="grouping">
                <option value="monthly">Monthly</option>
                <option value="quarterly">Quarterly</option>
                <option value="yearly">Yearly</option>
            </select>

            
        </div>
    </div>

    <div id="content-container">
        <div id="chart-container">
            <canvas id="trendChart"></canvas>
        </div>
        <div id="text-container">
            <h2>Smart AI Overview Analysis</h2>
            <p>This section provides insights generated by Smart AI, including trends, anomalies, and predictions based on the selected demographic and usage data. Use this space to display additional summaries or highlights relevant to the analysis.</p>
        </div>
    </div>

    <script>
        const dataPath = 'data/Merged_Usage_Patient_Data.csv'; // Path to the CSV file

        function toggleFilters() {
            const filtersContainer = document.getElementById('filters-container');
            const showFilters = document.getElementById('show-filters').checked;
            filtersContainer.style.display = showFilters ? 'block' : 'none';
        }

        async function fetchData() {
            try {
                const response = await fetch(dataPath);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const text = await response.text();
                const rows = text.split('\n').slice(1).filter(row => row.trim() !== '');
                return rows.map(row => {
                    const [PatientID, Year, Month, UsageFrequency, Age, Gender, Province, HealthCondition, AgeGroup] = row.split(',');
                    return { PatientID, Year, Month: +Month, UsageFrequency: +UsageFrequency, Age: +Age, Gender, Province, HealthCondition, AgeGroup };
                });
            } catch (error) {
                console.error("Error fetching or parsing data:", error);
                document.getElementById('error-message').style.display = 'block';
                return [];
            }
        }

        async function initializeFilters(data) {
            const provinces = [...new Set(data.map(d => d.Province))].sort();
            const healthConditions = [...new Set(data.map(d => d.HealthCondition))].sort();
            const ageGroups = [...new Set(data.map(d => d.AgeGroup))].sort();

            const provinceSelect = document.getElementById('filter-province');
            provinces.forEach(province => {
                const option = document.createElement('option');
                option.value = province;
                option.textContent = province;
                provinceSelect.appendChild(option);
            });

            const healthSelect = document.getElementById('filter-health');
            healthConditions.forEach(condition => {
                const option = document.createElement('option');
                option.value = condition;
                option.textContent = condition;
                healthSelect.appendChild(option);
            });

            const ageGroupSelect = document.getElementById('filter-age-group');
            ageGroups.forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                option.textContent = group;
                ageGroupSelect.appendChild(option);
            });
        }

        function filterData(data, filters) {
            return data.filter(d => {
                return (!filters.gender || d.Gender === filters.gender) &&
                       (!filters.province || d.Province === filters.province) &&
                       (!filters.healthCondition || d.HealthCondition === filters.healthCondition) &&
                       (!filters.ageGroup || d.AgeGroup === filters.ageGroup);
            });
        }

        function groupDataBySubgroups(data, groupBy, subGroupKey) {
            const grouped = {};

            data.forEach(d => {
                let key;
                if (groupBy === 'monthly') {
                    key = `${d.Year}-${d.Month}`;
                } else if (groupBy === 'quarterly') {
                    const quarter = Math.ceil(d.Month / 3);
                    key = `${d.Year}-Q${quarter}`;
                } else if (groupBy === 'yearly') {
                    key = `${d.Year}`;
                }

                const subGroup = subGroupKey !== 'none' ? d[subGroupKey] : 'Overall';
                if (!grouped[subGroup]) grouped[subGroup] = {};
                if (!grouped[subGroup][key]) grouped[subGroup][key] = 0;
                grouped[subGroup][key] += d.UsageFrequency;
            });

            return grouped;
        }

        function formatChartData(groupedData) {
            const labels = [...new Set(Object.values(groupedData).flatMap(group => Object.keys(group)))].sort();
            const datasets = Object.entries(groupedData).map(([subGroup, data]) => {
                const dataValues = labels.map(label => data[label] || 0);
                return {
                    label: subGroup,
                    data: dataValues,
                    borderColor: `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 1)`,
                    tension: 0.1,
                    fill: false,
                    pointStyle: 'circle',
                    pointRadius: 5,
                    pointHoverRadius: 7,
                };
            });

            return { labels, datasets };
        }

        function updateChart(chart, data) {
            chart.data.labels = data.labels;
            chart.data.datasets = data.datasets;
            chart.options.plugins.tooltip.callbacks.label = function(context) {
                return `${context.dataset.label}: ${context.raw}`;
            };
            chart.options.plugins.datalabels = {
                align: 'end',
                anchor: 'end',
                formatter: (value, context) => context.dataset.label
            };
            chart.update();
        }

        async function applyFilters() {
            const data = await fetchData();

            const filters = {
                gender: document.getElementById('filter-gender').value,
                province: document.getElementById('filter-province').value,
                healthCondition: document.getElementById('filter-health').value,
                ageGroup: document.getElementById('filter-age-group').value,
            };

            const groupBy = document.getElementById('grouping').value;
            const subGroupKey = document.getElementById('demographic-toggle').value || 'none';

            const filteredData = filterData(data, filters);
            const groupedData = groupDataBySubgroups(filteredData, groupBy, subGroupKey);
            const chartData = formatChartData(groupedData);

            updateChart(trendChart, chartData);
        }

        // Initialize the chart
        const ctx = document.getElementById('trendChart').getContext('2d');
        const trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                responsive: true,
                layout: {
                    padding: {
                        left: 20,
                        right: 20,
                        bottom: 30,
                    }
                },
                plugins: {
                    legend: { position: 'top' },
                    title: { display: true, text: 'User Trend Analysis' },
                }
            }
        });

        // Load data and initialize filters on page load
        fetchData().then(data => {
            applyFilters();
            console.log("Loaded data:", data);
            initializeFilters(data);
        });
    </script>
</body>
</html>
